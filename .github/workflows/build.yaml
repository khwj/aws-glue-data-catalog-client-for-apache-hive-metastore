name: Build Workflow

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 8
        uses: actions/setup-java@v2
        with:
          java-version: '8'
          distribution: 'adopt'
      - name: Cache Maven packages
        uses: actions/cache@v2
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      - name: Checkout patched version of Hive
        uses: actions/checkout@v2
        with:
          repository: khwj/hive
          path: './hive'
          ref: branch-2.3-imetastore
      - name: Install Hive locally
        working-directory: './hive'
        run: mvn clean install -DskipTests -Dmaven.javadoc.skip=true -pl shims,service-rpc,common,serde,metastore,vector-code-gen,llap-client,llap-tez,spark-client,ql
      - name: Run unit tests
        run: |
          mvn verify -Dmaven.test.skip=com.amazonaws.glue.catalog.metastore.integrationtest
        env:
          AWS_REGION: ap-southeast-1
          AWS_ACCESS_KEY: ${{secrets.AWS_ACCESS_KEY}}
          AWS_SECRET_KEY: ${{secrets.AWS_SECRET_KEY}}
      - name: Build
        run: mvn install package -DskipTests -Dhive2.version=2.3.7 -Dhadoop.version=3.2.0
